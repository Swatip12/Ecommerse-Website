<div class="order-detail-container">
  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>Loading order details...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !isLoading">
    <div class="error-icon">
      <i class="material-icons">error_outline</i>
    </div>
    <h2>Unable to Load Order</h2>
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="goBack()">
      Back to Orders
    </button>
  </div>

  <!-- Order Details -->
  <div class="order-content" *ngIf="order && !isLoading">
    <!-- Header -->
    <div class="order-header">
      <div class="header-left">
        <button class="back-btn" (click)="goBack()">
          <i class="material-icons">arrow_back</i>
          Back to Orders
        </button>
        <div class="order-title">
          <h1>Order #{{ order.orderNumber }}</h1>
          <p class="order-date">Placed on {{ formatDate(order.createdAt) }}</p>
        </div>
      </div>
      <div class="header-right">
        <span class="status-badge" [ngClass]="getOrderStatusColorClass(order.status)">
          {{ getOrderStatusDisplayName(order.status) }}
        </span>
      </div>
    </div>

    <!-- Order Progress -->
    <div class="order-progress" *ngIf="order.status !== 'CANCELLED' && order.status !== 'REFUNDED'">
      <div class="progress-steps">
        <div class="progress-step" 
             [class.completed]="order.status !== 'PENDING'"
             [class.active]="order.status === 'PENDING'">
          <div class="step-icon">
            <i class="material-icons">schedule</i>
          </div>
          <div class="step-label">Order Placed</div>
        </div>
        
        <div class="progress-line" 
             [class.completed]="order.status !== 'PENDING' && order.status !== 'CONFIRMED'"></div>
        
        <div class="progress-step" 
             [class.completed]="order.status === 'PROCESSING' || order.status === 'SHIPPED' || order.status === 'DELIVERED'"
             [class.active]="order.status === 'CONFIRMED'">
          <div class="step-icon">
            <i class="material-icons">check_circle</i>
          </div>
          <div class="step-label">Confirmed</div>
        </div>
        
        <div class="progress-line" 
             [class.completed]="order.status === 'SHIPPED' || order.status === 'DELIVERED'"></div>
        
        <div class="progress-step" 
             [class.completed]="order.status === 'SHIPPED' || order.status === 'DELIVERED'"
             [class.active]="order.status === 'PROCESSING'">
          <div class="step-icon">
            <i class="material-icons">settings</i>
          </div>
          <div class="step-label">Processing</div>
        </div>
        
        <div class="progress-line" 
             [class.completed]="order.status === 'DELIVERED'"></div>
        
        <div class="progress-step" 
             [class.completed]="order.status === 'DELIVERED'"
             [class.active]="order.status === 'SHIPPED'">
          <div class="step-icon">
            <i class="material-icons">local_shipping</i>
          </div>
          <div class="step-label">Shipped</div>
        </div>
        
        <div class="progress-line" 
             [class.completed]="order.status === 'DELIVERED'"></div>
        
        <div class="progress-step" 
             [class.completed]="order.status === 'DELIVERED'"
             [class.active]="order.status === 'DELIVERED'">
          <div class="step-icon">
            <i class="material-icons">done_all</i>
          </div>
          <div class="step-label">Delivered</div>
        </div>
      </div>
      
      <div class="estimated-delivery" *ngIf="getEstimatedDeliveryDate()">
        <p>Estimated delivery: <strong>{{ getEstimatedDeliveryDate() }}</strong></p>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Order Items -->
        <div class="order-items-card">
          <h3>Items Ordered</h3>
          <div class="items-list">
            <div class="order-item" *ngFor="let item of order.orderItems">
              <div class="item-image">
                <img src="/assets/images/product-placeholder.png" 
                     [alt]="item.productName">
              </div>
              <div class="item-details">
                <div class="item-name">{{ item.productName }}</div>
                <div class="item-sku">SKU: {{ item.productSku }}</div>
                <div class="item-price">{{ formatCurrency(item.unitPrice) }} each</div>
                <div class="item-quantity">Quantity: {{ item.quantity }}</div>
                <div class="item-discount" *ngIf="item.hasDiscount">
                  Discount: {{ formatCurrency(item.discountAmount) }}
                </div>
              </div>
              <div class="item-total">
                {{ formatCurrency(item.totalPrice) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Status History -->
        <div class="status-history-card">
          <h3>Order Status History</h3>
          <div class="loading-history" *ngIf="isLoadingHistory">
            <div class="loading-spinner-small"></div>
            <span>Loading history...</span>
          </div>
          <div class="history-timeline" *ngIf="!isLoadingHistory">
            <div class="timeline-item" *ngFor="let historyItem of statusHistory">
              <div class="timeline-icon" [ngClass]="getStatusIconColor(historyItem.newStatus)">
                <i class="material-icons">{{ getStatusIcon(historyItem.newStatus) }}</i>
              </div>
              <div class="timeline-content">
                <div class="timeline-header">
                  <span class="status-change">
                    <span *ngIf="historyItem.previousStatus">{{ historyItem.previousStatus }} → </span>
                    {{ historyItem.newStatus }}
                  </span>
                  <span class="timeline-date">{{ formatShortDate(historyItem.createdAt) }}</span>
                </div>
                <div class="timeline-notes" *ngIf="historyItem.notes">
                  {{ historyItem.notes }}
                </div>
                <div class="timeline-meta">
                  <span *ngIf="isSystemChange(historyItem)" class="system-change">System Update</span>
                  <span *ngIf="!isSystemChange(historyItem)" class="user-change">Manual Update</span>
                  <span *ngIf="isStatusUpgrade(historyItem)" class="status-upgrade">✓ Progress</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Order Summary -->
        <div class="order-summary-card">
          <h3>Order Summary</h3>
          <div class="summary-content">
            <div class="summary-line">
              <span>Subtotal ({{ order.totalItemCount }} items):</span>
              <span>{{ formatCurrency(order.subtotal) }}</span>
            </div>
            <div class="summary-line">
              <span>Tax:</span>
              <span>{{ formatCurrency(order.taxAmount) }}</span>
            </div>
            <div class="summary-line">
              <span>Shipping:</span>
              <span>{{ order.shippingAmount === 0 ? 'FREE' : formatCurrency(order.shippingAmount) }}</span>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-line total">
              <span>Total:</span>
              <span>{{ formatCurrency(order.totalAmount) }}</span>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="payment-info-card">
          <h3>Payment Information</h3>
          <div class="payment-content">
            <div class="payment-status">
              <span class="payment-label">Status:</span>
              <span class="payment-value" 
                    [ngClass]="order.paymentStatus === 'PAID' ? 'text-green-600' : 'text-yellow-600'">
                {{ order.paymentStatus === 'PAID' ? 'Paid' : 'Pending' }}
              </span>
            </div>
            <div class="payment-method">
              <span class="payment-label">Method:</span>
              <span class="payment-value">Credit Card ending in ****</span>
            </div>
            <div class="payment-amount">
              <span class="payment-label">Amount:</span>
              <span class="payment-value">{{ formatCurrency(order.totalAmount) }}</span>
            </div>
          </div>
        </div>

        <!-- Shipping Information -->
        <div class="shipping-info-card">
          <h3>Shipping Information</h3>
          <div class="shipping-content">
            <div class="shipping-address">
              <h4>Shipping Address</h4>
              <!-- TODO: Display actual shipping address when address service is implemented -->
              <div class="address-placeholder">
                <p>Shipping address will be displayed here</p>
                <p class="address-id">Address ID: {{ order.shippingAddressId }}</p>
              </div>
            </div>
            <div class="billing-address" *ngIf="order.billingAddressId && order.billingAddressId !== order.shippingAddressId">
              <h4>Billing Address</h4>
              <div class="address-placeholder">
                <p>Billing address will be displayed here</p>
                <p class="address-id">Address ID: {{ order.billingAddressId }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Actions -->
        <div class="order-actions-card">
          <h3>Order Actions</h3>
          <div class="actions-content">
            <button class="btn btn-outline" (click)="trackOrder()">
              <i class="material-icons">track_changes</i>
              Track Order
            </button>
            
            <button 
              class="btn btn-outline" 
              (click)="reorderItems()"
              *ngIf="order.status === 'DELIVERED'">
              <i class="material-icons">refresh</i>
              Reorder Items
            </button>
            
            <button 
              class="btn btn-outline" 
              (click)="downloadInvoice()"
              *ngIf="order.paymentStatus === 'PAID'">
              <i class="material-icons">download</i>
              Download Invoice
            </button>
            
            <button 
              class="btn btn-danger" 
              (click)="openCancelDialog()"
              *ngIf="canCancelOrder()">
              <i class="material-icons">cancel</i>
              Cancel Order
            </button>
          </div>
        </div>

        <!-- Order Notes -->
        <div class="order-notes-card" *ngIf="order.notes">
          <h3>Order Notes</h3>
          <div class="notes-content">
            <p>{{ order.notes }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Order Dialog -->
  <div class="modal-overlay" *ngIf="showCancelDialog" (click)="closeCancelDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Cancel Order</h3>
        <button class="close-btn" (click)="closeCancelDialog()">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to cancel order #{{ order?.orderNumber }}?</p>
        <div class="form-field">
          <label for="cancelReason">Reason for cancellation:</label>
          <textarea 
            id="cancelReason"
            [(ngModel)]="cancelReason"
            placeholder="Please provide a reason for cancelling this order..."
            rows="3"
            required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCancelDialog()" [disabled]="isCancelling">
          Keep Order
        </button>
        <button 
          class="btn btn-danger" 
          (click)="confirmCancelOrder()" 
          [disabled]="!cancelReason.trim() || isCancelling">
          <span *ngIf="!isCancelling">Cancel Order</span>
          <span *ngIf="isCancelling">Cancelling...</span>
        </button>
      </div>
    </div>
  </div>
</div>